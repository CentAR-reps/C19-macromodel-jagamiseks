---
title: |
  ![](logod.png){width=12in}  
  Välisnõudlus
author: "CITIS"
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: cosmo
---

```{css caption-to-the-top, echo = FALSE}
/* Makes figure caption behave like table caption and places is to the top*/ 
div.figure {
  display: table;
  width:100%;
}
div.figure p {
  display: table-caption;
  caption-side: top;
  width: 100%;
}
caption {
  text-align: left !important;
  color: #333333 !important;
} 
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(knitr)
library(DT)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(heatmaply)

```

```{r}

wd <- getwd()
wd <- ".."
script_loc <<- file.path(wd, "1.scripts")  
data_loc <<- file.path(wd, "2.data")
dict_loc <<- file.path(wd, "3.dictionaries")
ui_loc <<- file.path(wd, "5.reports/raportite_lähteandmed")
input_filename <<- "changes in export.xlsx"
intervall <<- "kuu"

source(file.path(script_loc,"packages.R"), encoding = "UTF-8")
source(file.path(script_loc,"export_functions.R"), encoding = "UTF-8")

load(file.path(data_loc, "export_module/ibci_export_shares.Rda"))
load(file.path(data_loc, "export_module/ibc_export_shares.Rda"))
load(file.path(data_loc, "export_module/export_baseline.Rda"))

export_baseline <- export_baseline %>% 
  filter(type == "goods_and_services") %>% 
  dplyr::select(-type)
  

sheetnames <- getSheetNames(file = file.path(ui_loc, "changes in export.xlsx"))
user_input <- lapply(sheetnames, function(x){
  openxlsx::read.xlsx(file.path(ui_loc, "changes in export.xlsx"), sheet = x)})
names(user_input) = sheetnames

dictionaries <- read_excel(file.path(dict_loc, "dictionaries.xlsx"))
colnames(dictionaries) = tolower(make.names(colnames(dictionaries)))
oecd_agr <- openxlsx::read.xlsx(file.path(data_loc, "export_module/ReadMe_ICIO_CSV.xlsx"), sheet = "Country_Industry", startRow = 3, cols = c(7,8))

```

# Sihtturgude struktuur

Ekspordi nõudluses toimuvate muudatuste arvessevõtmiseks toetutakse rahvusvahelisele sisendväljundraamistikule. Kasutatakse OECD 2015. aasta riikidevahelisi sisend-väljund (IO) tabelit (https://www.oecd.org/sti/ind/inter-country-input-output-tables.htm), mis võimaldab arvestada nõudlust sihtriigi-majandusharu (edaspidi sihtturg) lõikes. OECD I-O andmestik sisaldab teavet 64 riigi (36 OECD-sse kuuluvat riiki, 28 OECD-sse mittekuuluvat riiki, lisaks ülejäänud maailm kokku agregeerituna) ja 36 majandusharu kohta. Lisaks majandusharude vahelistele tehingumahtudele on andmestikus kajastatud lõpptarbimine (sh kodumajapidamiste ja valitsuste poolt teostatud tarbimine, põhivara ja varude muutus, vt [Lõpptarbimise definitsioon](#fd_def)) ning majandusharude lisandväärtus. OECD sisend-väljund tabel sisaldab nii kaupade kui teenuste eksporti. 

Ekspordi nõudluse arvutamiseks võetakse arvesse vaid otseseid efekte, rahvusvahelise IO tabeli põhjal teiseseid efekte, kuidas teiste riikide omavahelised kaubamahu muutused mõjutavad Eesti majandusharude väljundit, arvesse ei võeta.

OECD I-O andmete kasutamise eesmärgiks on igale Eesti majandusharule leida sihtturgude osakaalud. Lisaks sihtturgude riik-majandusharu paaridele on juurde lisatud riik-lõpptarbimine (FD) osakaalud. Seejuures eeldatakse, et 2015. aastaga võrreldes ei ole struktuuris muutusi toimunud. 

Näiteks puidu ja puittoodete (majandusharu koodiga 16) sihtturgude jaotus on esitatud allolevas tabelis:

```{r}
ibci_export_shares %>% 
  filter(origin_industry == "16") %>% 
  datatable() %>%
    formatRound(columns=c('export_share'), digits=5)
```

## Majandusharude agregatsioon

OECD andmestikus on mitmed majandusharud kokku agregeeritud. Kuna eesmärk on Eesti majandusharusid eristada, siis on eeldatud, et komponentharudel on sama eksporditurgude struktuur. Näiteks 01T03 all on koos põllumajandus, metsandus ja kalandus ning seejuures eeldatakse, et nende sihtturgude osatähtsuste jaotused on samad. 

Sihtturgude agregatsioon on selguse huvides jäetud samaks OECD agregatsioonile (36 majandusharu + lõpptarbimine). Selleks, et ekspordi mooduli väljundit projekti muude moodulitega mugavalt siduda, on sisemaiste majandusharude agregatsioon viidud vastavusse projekti teistes moodulites kasutatava agregatsiooniga (kokku 62 majandusharu). Projektis kasutatava agregatsiooni ja OECD agregatsioonivastavused on esitatud allolevas tabeli. Seejuures ridade värv näitab, kas OECD agregatsioon on lahku löödud (sinine), OECD harusid on kokku täiendavalt kokku agregeeritud (roheline) või on kattuv agregatsioon (valge).

```{r}

oecd_agr <- oecd_agr %>% 
  mutate(Code = str_remove(Code, "D")) %>% 
  tidyr::separate(Code, 
                  into = c("start", "end"), 
                  sep = "T",
                  remove = FALSE,
                  fill = "right") %>% 
  mutate(end = ifelse(is.na(end), start, end),
         start = as.numeric(start),
         end = as.numeric(end))
  
origin_industries_list <- list()
for (i in seq_len(nrow(oecd_agr))){
  origin_industries_list[[i]] = data.frame(origin_industry_raw = oecd_agr$Code[i],
                                           origin_industry_text = oecd_agr$Industry[i],
                                           origin_industry = seq(from = oecd_agr$start[i],
                                                                 to = oecd_agr$end[i],
                                                                 by = 1),
                                                      stringsAsFactors = FALSE)
}

origin_industries <- bind_rows(origin_industries_list)
origin_industries <- origin_industries %>% 
  mutate(origin_industry = ifelse(origin_industry < 10, paste0("0",origin_industry), origin_industry))

# Add 'Kood IO tabel'
origin_industries <- origin_industries %>% 
  left_join(dictionaries %>% 
              dplyr::select(kood.emtak2008, kood.io.tabel, tegevusala.tekst.io.tabel),
            by = c("origin_industry" = "kood.emtak2008")) %>% 
  filter(!is.na(kood.io.tabel))

origin_industries <- origin_industries %>% 
  dplyr::select(-origin_industry) %>% 
  unique()

origin_industries <- origin_industries %>% 
  group_by(origin_industry_raw) %>% 
  mutate(n_uus = n()) %>% 
  ungroup() %>% 
  group_by(kood.io.tabel) %>% 
  mutate(n_vana = n()) %>% 
  ungroup() %>% 
  mutate(type = case_when(
    n_uus == n_vana ~ "same",
    n_uus > 1 ~ "splitted",
    n_vana > 1 ~ "gathered",
    TRUE ~ "")) %>% 
  dplyr::select(-n_uus, -n_vana)
  
colnames(origin_industries) = c("OECD agregeering", "OECD tekst", "Projekti agregeering", "Projekti agregeeringu tekst", "type")

origin_industries %>% 
  dplyr::select(-type) %>% 
  kable(row.names = FALSE) %>%
  kable_styling() %>%
  row_spec(which(origin_industries$type == "splitted"),  background = "lightblue") %>% 
  row_spec(which(origin_industries$type == "gathered"),  background = "lightgreen")
```

# Ekspordi baastasemed

Võtmaks arvesse kõige viimaseid saadaolevaid andmeid majandusharude ekspordimahtude osas, kasutatakse Statistikaameti väliskaubanduse andmeid. Andmed laetakse Statistikaameti API vahendusel (vaikimisi 2019. aasta andmed): 

 - kaupade ekspordimahud võetakse tabelist https://andmed.stat.ee/api/v1/et/stat/VK02
 - teenuste ekspordimahud võetakse tabelist https://andmed.stat.ee/api/v1/et/stat/VKT10. 
 
Koondekspordimahtude saamiseks liidetakse kaupade ja teenuste ekspordimahud majandusharude lõikes kokku. Ekspordimooduli kasutamise käigus on võimalik määrata, kas läbimängitavad stsenaariumid hõlmavad vaid kaupade, teenuste või kaupade ja teenuste eksporti. Vaikimisi vaadeldake kogueksporti, võttes arvesse nii eksporditavate kaupade kui teenuste mahtusid. Vaid kaupade või teenuste analüüsimisel on eeldatud, et sihtturgude struktuur on neil sama kui koguekspordil. 

Kuna antud andmestik kajastab aastast ekspordimahtu, siis kuiste simulatsioonide korral jagatakse vastavad väärtused läbi 12-ga. Sellisest lähenemisest tulenevalt ei ole võimalik arvesse võtta ekspordi sessoonsust.

Saadud väärtusi kasutatakse simulatsioonides nn baastasemetena, mille suhtes hakatakse muutusi vastavalt kasutajapoolsetele sisenditele arvutama.  

Ekspordi baastasemed (aastased summad) on leitavad allolevast tabelist:

```{r}
export_baseline %>% 
  datatable() %>%
    formatRound(columns=c('export_amount'), digits=0)
```

# Kasutajapoolne sisend

Ekspordimooduli jaoks vajaminev kasutajapoolne sisend määratakse xlsx formaadiga failis (näit. *Andmete sisestamise vormi näidis-eksport.xlsx*). Olenevalt soovitavast detailsusest on kasutajal võimalik mooduli kasutamisel määrata, kas sihtturge soovitakse arvestada riigi tasemel või riik-majandusharu tasemel.  

Iga sisemaise majandusharu jaoks on andmetes 64 sihtturgu riigi tasemel ja 64*37 = 2368 sihtturgu riik-majandusharu tasemel (63 + 1 riiki ja 36 + 1 majandusharu). Kuna niivõrd suure arvu sisendparameetrite manuaalne sisestamine ei oleks mõeldav, on vaja teha üldistusi. Ekspordimoodulis on kasutusel kaks omavahel kombineeritavat lähenemist kasutajapoolse sisendi määramiseks: topK ja sihtturu põhine lähenemine. Kui mingi majandusharu ekspordi mahu arvutus on mõjutatud nii topK kui sihtturu põhistest sisenditest, siis esimese prioriteedina võetakse arvesse topK lehel olev sisend.  

## topK

Iga sisemaise majandusharu jaoks leitakse $k$ kõige olulisemat sihtturgu. Kasutajal on võimalik seejuures parameetri $k$ abil kõige olulisemate sihtturgude arvu määrata. Ülejäänud sihtturud agregeeritakse kokku ülejäänud maailma alla, majandusharude detailsust arvesse võtmata (kood *ROW*). 

Iga majandusharu 5 kõige olulisemat riik-majandusharu sihtturgu (+ ülejäänud maailm) on esitatud allolevas tabelis:

```{r}
find_topK_export_destinations(5, "ci") %>% 
  datatable() %>%
    formatRound(columns=c('export_share'), digits=5)
```

(Märkus: kuna majandusharude "01- Taime- ja loomakasvatus", "02 - Metsamajandus ja metsavarumine" ja "03 - 	Kalapüük ja vesiviljelus" korral eeldatakse sama, koondagregatsioonile "01-03" vastavat sihtturgude jaotust, esineb ka harude "02" ja "03" korral suur Saudi Araabia lõpptarbimise osakaal.)

Iga majandusharu 5 kõige olulisemat riigi tasemel sihtturgu (+ ülejäänud maailm) on esitatud allolevas tabelis:

```{r}
find_topK_export_destinations(5, "c") %>% 
  datatable() %>%
    formatRound(columns=c('export_share'), digits=5)
```

Kasutaja saab sisendfailis lehel *topK* iga majandusharu $k$ kõige olulisema sihtturu (ja lisaks *ROW*) jaoks määrata, mil määral nõudlus suureneb/väheneb. Seejuures veergudena saab käsitleda muutust üle kuude (n-ö aegreana) kui ka tsenaariume eraldiseisvalt.  

>Näide:
Ligemale 6% põllumajanduse ekspordist müüakse Soome lõpptarbimisse. Kasutaja on määranud, et piirangutest tuleneval on jaanuaris ja veebruaris 2021 antud sihtturg 100% ning märtsis 2021 50% ulatuses ära kukkunud (sisendi tüüp *relative_change* korral). Lisaks on kasutaja eeldanud, et alates aprillist on ekspordimaht saavutanud baastaseme, ning et muudel turgudel baastasemega võrreldes muutusi pole.  

```{r}
user_input$topK %>%
  head(6) %>%
  datatable() %>%
    formatRound(columns=c('export_share'), digits=3)
```

## Sihtturu põhine lähenemine

Antud lähenemise korral määratakse, kui palju sihtturgude lõikes nõudlus suureneb/väheneb. Sisestatud muutused kantakse proportsionaalselt üle kõikidele sisemaistele majandusharudele. 
Sõltuvalt sellest, kas sihtturu detailsuseks on riik või riik-majandusharu, erineb sisendfaili struktuur:

- *riik* korral toimub kõikide sihtriikide muutuste määramine lehel *countries*. Seejuures ridades on riigid ja veergudes kuud (aegrea korral) või tsenaariumid. 
- *riik-majandusharu* korral on iga riigi jaoks loodud eraldi leht. Igal lehel on ridades majandusharud ja veergudes kuud (aegrea korral) või tsenaariumid.

> Näide:
Kasutaja hinnangute kohaselt väheneb Saksamaa autotööstuse (majandusharu Mootorsõidukite, haagiste ja poolhaagiste tootmine) osakaal baastasemega võrreldes jaanuaris ja veebruaris 2021 10%. Seejuures eeldatakse, et see mõjutab kõigi Eesti majandusharude eksporti Saksamaa autotööstusele samal määral. Selleks sisestab kasutaja sisendfaili lehele *DEU* majandusharu "Mootorsõidukite, haagiste ja poolhaagiste tootmine" jan. ja veb. 2021 väärtusteks -0.1 (sisendi tüüp *relative_change* korral).

```{r}
user_input$DEU %>%
  arrange(destination_industry != "29") %>% 
  datatable()
```

# Sisendi tüüp

Sisendfaili täitmisel on võimalik sisestada kolme tüüpi väärtuseid:

1. suhtelisi muutuseid (*relative_change*)
2. aboluutseid muutuseid (*absolute_change*)
3. absoluuttasemeid (*absolute_level*)

Seejuures peavad sisendid olema sama tüüpi üle sisendfaili, st nii topK kui sihtturu põhiste väärtuste tüübid on samad. Seda, millisele tüübile sisendfail vastab, määrab kasutaja ekpordi mooduli jooksutamisel.



## Suhtelised muutused

Suhteliste muutuste korral tuleb väärtused sisestada n-ö määrana, mitte protsendina. 

### Sisendite järjekord

1. võetakse arvesse kõik *topK* lehel olevad sisendid, mis ei vasta koodile *ROW*
2. kui koodile *ROW* vastab mittetühje sisendeid, siis need väärtused imputeeritakse kõigile *topK*-s mitteesinevatele sihtturgudele. (Märkus: *topK*-s olevad, kuid puuduvate väärtustega sihtturud jäävad jätkuvalt puuduvate väärtustega)
3. võetakse arvesse sihtturu põhised sisendid - kõik kirjed, mis ei ole veel kasutaja poolt väärtust saanud, imputeeritakse sihtturu põhiste väärtustega. (Märkus: kui on soov, et *topK* lehel oleva sihtturu sisendi väärtuseks oleks 0 (st muutus on 0), kuid sellele sihturule vastava sihtturu põhise sisendi väärtuseks on nullist erinev arv, siis tuleb ka *topK* lehel vastav sisend 0-ga väärtustada.)
4. Kõik jätkuvalt puuduvat väärtust omavad kirjed imputeeritakse väärtusega 0.

### Ekspordinõudluse arvutamine

Kasutaja poolt sisestatud muutustele vastavalt arvutatakse majandusharude ekspordinõudluse simuleeritud väärtused:

$$\hat{X_{i,t}} = \sum_{j = i}^{N}(1+\Delta x_{i,t}^j) p_{i}^jX_{i,t},$$
kus 

- $X_{i,t}$ tähistab majandusharu $i$ ekpordi baastaset kuul $t$, 
- $p_{i}^j$ tähistab majandusharule $i$ vastava sihtturu $j$ osakaalu
- $\Delta x_{i,t}^j$ tähistab kasutaja poolt sisestatud majandusharule $i$ vastava sihtturu $j$ ekspordimahu suhtelist muutust kuul $t$,
- $N$ on sihtturgude arv.

*Märkus: kuud $t$ eristatakse juhul, kui sisendit väljendatakse aegreana. Tsenaariumite korral ajalist mõõdet ei esine. See kehtib ka järgnevate valemite korral.*

## Absoluutsed muutused

Absoluutsete muutuste korral tuleb väärtused sisestada eurodes.  

### Sisendite järjekord

1. võetakse arvesse kõik *topK* lehel olevad sisendid, mis ei vasta koodile *ROW*
2. kui koodile *ROW* vastab mittetühje sisendeid, siis need väärtused imputeeritakse kõigile *topK*-s mitteesinevatele sihtturgudele. Seejuures koodile *ROW* vastav väärtus skaleeritakse mitte *topK*-s olevate sihtturgude vahel vastavalt nende ekspordi osakaalule. (Märkus: *topK*-s olevad, kuid puuduvate väärtustega sihtturud jäävad jätkuvalt puuduvate väärtustega)
3. võetakse arvesse sihtturu põhised sisendid - kõik kirjed, mis ei ole veel kasutaja poolt väärtust saanud, imputeeritakse sihtturu põhiste väärtustega. Seejuures sisendid skaleeritakse sihtturule vastavate imputeeritavate sisemaiste majandusharude osatähtsuse alusel. Seega sihtturu põhised sisendid ei sisalda *topK* lehel määratud väärtusi. (Märkus: kui on soov, et *topK* lehel oleva sihtturu sisendi väärtuseks oleks 0 (st muutus on 0), kuid sellele sihturule vastava sihtturu põhise sisendi väärtuseks on nullist erinev arv, siis tuleb ka *topK* lehel vastav sisend 0-ga väärtustada.)
4. Kõik jätkuvalt puuduvat väärtust omavad kirjed imputeeritakse väärtusega 0.

### Ekspordinõudluse arvutamine

Kasutaja poolt sisestatud muutustele vastavalt arvutatakse majandusharude ekspordinõudluse simuleeritud väärtused:

$$\hat{X_{i,t}} = \sum_{j = i}^{N}p_{i}^jX_{i,t}+\Delta x_{i,t}^j,$$
kus 

- $X_{i,t}$ tähistab majandusharu $i$ ekpordi baastaset kuul $t$, 
- $p_{i}^j$ tähistab majandusharule $i$ vastava sihtturu $j$ osakaalu
- $\Delta x_{i,t}^j$ tähistab kasutaja poolt sisestatud majandusharule $i$ vastava sihtturu $j$ ekspordimahu absoluutset muutust kuul $t$,
- $N$ on sihtturgude arv.

## Absoluuttasemed

Absoluutsete tasemete korral tuleb väärtused sisestada eurodes.  

### Sisendite järjekord

1. võetakse arvesse kõik *topK* lehel olevad sisendid, mis ei vasta koodile *ROW*
2. kui koodile *ROW* vastab mittetühje sisendeid, siis need väärtused imputeeritakse kõigile *topK*-s mitteesinevatele sihtturgudele. Seejuures koodile *ROW* vastav väärtus skaleeritakse mitte *topK*-s olevate sihtturgude vahel vastavalt nende ekspordi osakaalule. (Märkus: *topK*-s olevad, kuid puuduvate väärtustega sihtturud jäävad jätkuvalt puuduvate väärtustega)
3. võetakse arvesse sihtturu põhised sisendid - kõik kirjed, mis ei ole veel kasutaja poolt väärtust saanud, imputeeritakse sihtturu põhiste väärtustega. Seejuures sisendid skaleeritakse sihtturule vastavate imputeeritavate sisemaiste majandusharude osatähtsuse alusel. Seega sihtturu põhised sisendid ei sisalda *topK* lehel määratud väärtusi. (Märkus: kui on soov, et *topK* lehel oleva sihtturu sisendi väärtuseks oleks baastase, kuid sellele sihturule vastava sihtturu põhise sisendi väärtuseks on nullist erinev arv, siis tuleb ka *topK* lehel vastav sisend baastasemega väärtustada.)
4. Kõik jätkuvalt puuduvat väärtust omavad kirjed imputeeritakse baastaseme väärtusega.

### Ekspordinõudluse arvutamine

Kasutaja poolt sisestatud muutustele vastavalt arvutatakse majandusharude ekspordinõudluse simuleeritud väärtused:

$$\hat{X_{i,t}} = \sum_{j = i}^{N}\tilde{X_{i,t}^j},$$
kus 

- $\tilde{X_{i,t}^j}$ tähistab majandusharu $i$ ekpordimahtu sihtturule $j$ kuul $t$, 
- $N$ on sihtturgude arv,

seejuures juhul, kui kasutaja on väärtuse määranud, on $\tilde{X_{i,t}^j}$ võrdne sisestatud väärtusega, vastasel juhul on see imputeeritud baastasemega: $\tilde{X_{i,t}^j} = p_{i}^jX_{i,t}$.

# Väljund

Ekpordi mooduli väljund on laial kujul andmetabel, milles ridades on sisemaised majandusharud ja veergudes kuud aegrea korral või tsenaariumid. Väärtusteks on ekspordi mahu muutuste hinnangud absoluutsummas (eurodes):

$$\Delta_{i,t} = \hat{X_{i,t}} - X_{i,t},$$

- $X_{i,t}$ tähistab majandusharu $i$ ekpordi baastaset kuul $t$, 
- $\hat{X_{i,t}}$ tähistab majandusharu $i$ simuleeritud eksportdi taset kuul $t$,
- $\Delta_{i,t}$ tähistab majandusharu $i$ ekspordimahu absoluutssummas muutust kuul $t$ (baastasemega võrreldes).

## Näide

```{r}
export_demand <- calculate_export_demand_change(input_type = "relative_change", intervall = intervall)

#amounts = round(export_demand[,-c(1,2)]) %>% 
#  as.data.frame()
# export_demand <- export_demand %>% 
#   dplyr::select(industry_code, industry_text) %>% 
#   bind_cols(amounts)
export_demand %>% 
  datatable()

```

# Jaotused

## Heatmap

```{r, out.width = '100%', fig.height=8}
mat <- ibc_export_shares %>% 
  mutate(export_share = round(export_share,5)) %>% 
  spread(key = destination_country, value = export_share) %>% 
  as.data.frame()

rownames(mat) <- mat[,1]
mat <- mat %>% dplyr::select(-origin_industry, -origin_industry_text)
mat <- as.matrix(mat)


labels <- ibc_export_shares %>% 
  dplyr::select(-export_share) %>% 
  spread(key = destination_country, value = origin_industry_text) %>% 
  as.data.frame()

rownames(labels) <- labels[,1]
labels <- labels %>% dplyr::select(-origin_industry)
labels <- as.matrix(labels)

p <- heatmaply(mat, 
        dendrogram = "none",
        xlab = "", ylab = "", 
        main = "Ekspordi osakaal sihtriigi lõikes",
        grid_color = NA,
        grid_gap = 0,
        titleX = FALSE,
        hide_colorbar = FALSE,
        label_names = c("Sisemaine majandusharu", "Sihtriik", "Ekspordi osakaal"),
        fontsize_row = 6, fontsize_col = 6,
        labCol = colnames(mat),
        labRow = rownames(mat),
        heatmap_layers = theme(axis.line=element_blank()),
        custom_hovertext = labels,
        plot_method = "ggplot"
        )
p

# library(viridis)
# ggplot(ibc_export_shares, aes(x = destination_country, y = origin_industry, fill = export_share)) +
#   geom_tile() +
#   scale_fill_viridis(option = "B") +
#   theme(axis.text.x = element_text(angle = 90),
#         legend.position = "bottom") +
#   labs(x = "sihtriik", y = "sisemaine majandusharu", fill = "ekspordi osakaal",
#        title = "Ekspordi osakaal sihtriigi lõikes")
```

```{r, out.width = '100%', fig.height=8}
mat <- ibci_export_shares %>% 
  mutate(export_share = round(export_share,8)) %>% 
  tidyr::unite(col = destination, destination_country, destination_industry) %>%
  dplyr::select(-destination_industry_text) %>% 
  spread(key = destination, value = export_share) %>% 
  as.data.frame()

rownames(mat) <- mat[,1]
mat <- mat %>% dplyr::select(-origin_industry, -origin_industry_text)
mat <- as.matrix(mat)


labels <- ibci_export_shares %>% 
  tidyr::unite(col = destination, destination_country, destination_industry) %>%
    mutate(label = paste(
    "Sisemaine haru:", origin_industry_text,
    "\nSihtharu:", destination_industry_text
  )) %>% 
  dplyr::select(-export_share, -origin_industry_text, -destination_industry_text) %>% 
  spread(key = destination, value = label) %>% 
  as.data.frame()

rownames(labels) <- labels[,1]
labels <- labels %>% dplyr::select(-origin_industry)
labels <- as.matrix(labels)

p <- heatmaply(mat, 
        dendrogram = "none",
        xlab = "", ylab = "", 
        main = "Ekspordi osakaal sihtriigi-majandusharu lõikes",
        grid_color = NA,
        grid_gap = 0,
        titleX = FALSE,
        hide_colorbar = FALSE,
        label_names = c("Sisemaine majandusharu", "Sihtturg", "Ekspordi osakaal"),
        fontsize_row = 6, fontsize_col = 6,
        labCol = NULL,
        labRow = rownames(mat),
        heatmap_layers = theme(axis.line=element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank()),
        custom_hovertext = labels,
        plot_method = "ggplot"
        )
p
```

## Kumulatiivsed osakaalud

Allolevad joonised näitavad sihtturgude kumulatiivseid osakaalusid sisemaiste majandusharude lõikes. Iga sisemaise majandusharu jaoks on sihtturud järjestatud ekspordi osakaalu järgi kahanevalt, seejuures *ROW* on jäetud positsioonilt viimaseks.

```{r, out.width = '100%', fig.height=10}
c_cumul <- ibc_export_shares %>% 
  arrange(origin_industry, destination_country == "ROW", desc(export_share)) %>% 
  group_by(origin_industry) %>% 
  mutate(cumul_share = cumsum(export_share),
         i = row_number()) %>% 
  ungroup()

ggplot(c_cumul, aes(x = i, y = cumul_share)) +
  geom_line(color = "steelblue3", size = 1.3) +
  facet_wrap(~origin_industry) +
  labs(x = "sihtturu indeks", y = "kumulatiivne osakaal", title = "Sihtriigi alusel")
```

```{r, out.width = '100%', fig.height=10}
ci_cumul <- ibci_export_shares %>% 
  arrange(origin_industry, destination_country == "ROW", desc(export_share)) %>% 
  group_by(origin_industry) %>% 
  mutate(cumul_share = cumsum(export_share),
         i = row_number()) %>% 
  ungroup()

ggplot(ci_cumul, aes(x = i, y = cumul_share)) +
  geom_line(color = "steelblue3", size = 1.3) +
  facet_wrap(~origin_industry) +
  labs(x = "sihtturu indeks", y = "kumulatiivne osakaal", title = "Sihtriigi-majandusharu alusel") +
  theme(axis.text.x = element_text(angle = 45))
```


## Kumulatiivsed osakaalud (top)


```{r, out.width = '100%', fig.height=10}
ggplot(c_cumul %>% filter(i < 10), aes(x = i, y = cumul_share)) +
  geom_line(color = "steelblue3", size = 1.3) +
  facet_wrap(~origin_industry) +
  labs(x = "sihtturu indeks", y = "kumulatiivne osakaal", title = "Sihtriigi alusel (top 10)")
```


```{r, out.width = '100%', fig.height=10}
ggplot(ci_cumul %>% filter(i < 25), aes(x = i, y = cumul_share)) +
  geom_line(color = "steelblue3", size = 1.3) +
  facet_wrap(~origin_industry) +
  labs(x = "sihtturu indeks", y = "kumulatiivne osakaal", title = "Sihtriigi-majandusharu alusel (top25)") +
  theme(axis.text.x = element_text(angle = 45))
```


# Lisad
## Lõpptarbimise definitsioon {#fd_def}

Lõpptarbimise alla agregeeritakse kokku järgmised OECD andmestikus olevad tunnused:

- HFCE	Households final consumption expenditure
- NPISH	Non-profit institutions serving households
- GGFC	General government final consumption
- GFCF	Gross fixed capital formation
- INVNT	Change in inventories and valuables
- P33	Direct purchases abroad
